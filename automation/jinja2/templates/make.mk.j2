{%- set plans_install = plans -%}
{%- set plans_delete = plans | reverse %}

# Automatic Content Generated

generate_documentation: ## Generate Terraform Documentation
generate_documentation:
{% for plan in plans_install %}
{% set plan_name = plan if not 'name' in plan else plan['name'] %}
	$(DOCKER_COMPOSE_DEV_TOOLS) run --rm --remove-orphans terraform_docs {{ plan_name }} --config=./.config/.terraform-docs.yml
{% endfor %}

terraform_terrascan: ## Terrascan Terraform
terraform_terrascan:
	$(TERRASCAN_RUN) scan -i terraform --verbose --config-path=./.terrascan_config.toml {% for plan in plans_install %}{% set plan_name = plan if not 'name' in plan else plan['name'] %} --iac-dir={{ plan_name }} {% endfor %}

format: ## Format all Terraform files using "terraform fmt"
format:
{% for plan in plans_install %}
{% set plan_name = plan if not 'name' in plan else plan['name'] %}
	@$(MAKE) --no-print-directory terraform_format CURRENT_DIR="{{ plan_name }}"
{% endfor %}

trivy:  ## Terraform Trivy
trivy:
{% for plan in plans_install %}
{% set plan_name = plan if not 'name' in plan else plan['name'] %}
	$(TRIVY_RUN) config {{ plan_name }} --config=./.config/.trivy.yaml --skip-dirs .terraform
{% endfor %}

validate: ## Validate all Terraform files using "terraform validate"
validate:
{% for plan in plans_install %}
{% set plan_name = plan if not 'name' in plan else plan['name'] %}
	@$(MAKE) --no-print-directory terraform_validate CURRENT_DIR="{{ plan_name }}"
{% endfor %}

lint: ## Check that good naming practices are respected in Terraform files (using tflint)
lint:
	$(TFLINT_RUN) --init
{% for plan in plans_install %}
{% set plan_name = plan if not 'name' in plan else plan['name'] %}
	@$(MAKE) --no-print-directory terraform_lint CURRENT_DIR="{{ plan_name }}"
{% endfor %}

{% for plan in plans_install %}
{% set plan_name = plan if not 'name' in plan else plan['name'] %}
{% set slug = plan_name | replace('/',"_") %}
console_{{ slug}}: ## Connect terraform Docker AWS {{ plan_name }} layer
console_{{ slug }}:
	@$(MAKE) --no-print-directory CURRENT_DIR={{ plan_name }} console_commands
{% endfor %}

{% for plan in plans_install %}
{% set plan_name = plan if not 'name' in plan else plan['name'] %}
{% set slug = plan_name | replace('/',"_") %}
tsvc_{{ slug}}: ## Check terraform module version {{ plan_name }}
tsvc_{{ slug }}:
	@$(MAKE) --no-print-directory CURRENT_DIR={{ plan_name }} terraform_check_version_commands
{% endfor %}

tsvc_all: ## Install all AWS layers
tsvc_all: {% for plan in plans_install %}{% set plan_name = plan if not 'name' in plan else plan['name'] %}{% set slug = plan_name | replace('/',"_") %}tsvc_{{ slug }} {% endfor %}


{% for plan in plans_install %}
{% set plan_name = plan if not 'name' in plan else plan['name'] %}
{% set slug = plan_name | replace('/',"_") %}
init_{{ slug}}: ## Init AWS {{ plan_name }} layer
init_{{ slug }}:
	@$(MAKE) --no-print-directory CURRENT_DIR={{ plan_name }} {% if 'override_init_parameters' in plan %}TERRAFORM_INIT_PARAMETERS="{{ plan['override_init_parameters'] }}" {% endif %}terraform_init_commands
{% endfor %}

{% for plan in plans_install %}
{% set plan_name = plan if not 'name' in plan else plan['name'] %}
{% set slug = plan_name | replace('/',"_") %}
validate_{{ slug}}: ## Validate AWS {{ plan_name }} layer
validate_{{ slug }}:
	@$(MAKE) --no-print-directory CURRENT_DIR={{ plan_name }} terraform_validate
{% endfor %}

{% for plan in plans_install %}
{% set plan_name = plan if not 'name' in plan else plan['name'] %}
{% set slug = plan_name | replace('/',"_") %}
plan_{{ slug}}: ## Plan AWS {{ plan_name }} layer
plan_{{ slug }}:
	@$(MAKE) --no-print-directory CURRENT_DIR={{ plan_name }} {% if 'override_var_parameters' in plan %}TERRAFORM_VAR_PARAMETERS="{{ plan['override_var_parameters'] }}" {% endif %}{% if 'additional_var_parameters' in plan %}ADDITIONAL_VAR_PARAMETERS="{{ plan['additional_var_parameters'] }}" {% endif %}terraform_plan_commands
{% endfor %}

{% for plan in plans_install %}
{% set plan_name = plan if not 'name' in plan else plan['name'] %}
{% set slug = plan_name | replace('/',"_") %}
apply_{{ slug }}: ## Apply AWS {{ plan_name }} layer
apply_{{ slug }}:
	@$(MAKE) --no-print-directory CURRENT_DIR={{ plan_name }} {% if 'override_var_parameters' in plan %}TERRAFORM_VAR_PARAMETERS="{{ plan['override_var_parameters'] }}" {% endif %}{% if 'additional_var_parameters' in plan %}ADDITIONAL_VAR_PARAMETERS="{{ plan['additional_var_parameters'] }}" {% endif %}terraform_apply_commands
{% endfor %}

{% for plan in plans_install %}
{% set plan_name = plan if not 'name' in plan else plan['name'] %}
{% set slug = plan_name | replace('/',"_") %}
install_{{ slug }}: ## Install AWS {{ plan_name }} layer
install_{{ slug }}:
	@$(MAKE) --no-print-directory CURRENT_DIR={{ plan_name }} {% if 'override_var_parameters' in plan %}TERRAFORM_VAR_PARAMETERS="{{ plan['override_var_parameters'] }}" {% endif %}{% if 'additional_var_parameters' in plan %}ADDITIONAL_VAR_PARAMETERS="{{ plan['additional_var_parameters'] }}" {% endif %}terraform_install_commands
{% endfor %}

{% for plan in plans_install %}
{% set plan_name = plan if not 'name' in plan else plan['name'] %}
{% set slug = plan_name | replace('/',"_") %}
destroy_{{ slug }}: ## Uninstall AWS {{ plan_name }} layer
destroy_{{ slug }}:
	@$(MAKE) --no-print-directory CURRENT_DIR={{ plan_name }} {% if 'override_var_parameters' in plan %}TERRAFORM_VAR_PARAMETERS="{{ plan['override_var_parameters'] }}" {% endif %}{% if 'additional_var_parameters' in plan %}ADDITIONAL_VAR_PARAMETERS="{{ plan['additional_var_parameters'] }}" {% endif %}terraform_destroy_commands
{% endfor %}

{% for plan in plans_install %}
{% set plan_name = plan if not 'name' in plan else plan['name'] %}
{% set slug = plan_name | replace('/',"_") %}
destroyauto_{{ slug }}: ## Uninstall AWS {{ plan_name }} layer automaticaly
destroyauto_{{ slug }}:
	@$(MAKE) --no-print-directory CURRENT_DIR={{ plan_name }} {% if 'override_var_parameters' in plan %}TERRAFORM_VAR_PARAMETERS="{{ plan['override_var_parameters'] }}" {% endif %}{% if 'additional_var_parameters' in plan %}ADDITIONAL_VAR_PARAMETERS="{{ plan['additional_var_parameters'] }}" {% endif %}terraform_destroyauto_commands
{% endfor %}


init_all: ## Init all AWS layers
init_all:
{% for plan in plans_install %}
{% set plan_name = plan if not 'name' in plan else plan['name'] %}
{% set slug = plan_name | replace('/',"_") %}
	@$(MAKE) --no-print-directory init_{{ slug }}
{% endfor %}

plan_all: ## Plan all AWS layers
plan_all:
{% for plan in plans_install %}
{% set plan_name = plan if not 'name' in plan else plan['name'] %}
{% set slug = plan_name | replace('/',"_") %}
	@$(MAKE) --no-print-directory plan_{{ slug }}
{% endfor %}

install_all: ## Install all AWS layers
install_all: {% for plan in plans_install %}{% set plan_name = plan if not 'name' in plan else plan['name'] %}{% set slug = plan_name | replace('/',"_") %}install_{{ slug }} {% endfor %}


destroy_all: ## Uninstall all layers
destroy_all: {% for plan in plans_delete %}{% set plan_name = plan if not 'name' in plan else plan['name'] %}{% set slug = plan_name | replace('/',"_") %}destroy_{{ slug }} {% endfor %}
